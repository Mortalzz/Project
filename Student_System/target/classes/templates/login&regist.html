<!DOCTYPE html>

<html  lang="zh" >
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <title>登录界面</title>
    <link rel="stylesheet" href="/css/auth.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: url(/imges/beauty.png);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            overflow: hidden; /* 隐藏溢出部分 */
        }
        .lowin-box {
            width: 400px; /* 登录框的宽度 */
            border-radius: 10px; /* 圆角 */
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* 阴影效果 */
        }
    </style>
</head>

<body>
<div class="lowin lowin-blue">
    <div class="lowin-brand">
        <img src="/imges/kodinger.jpg" alt="logo">
    </div>
    <div class="lowin-wrapper">
        <div class="lowin-box lowin-login">
            <div class="lowin-box-inner">
                <form id="login-form">
                    <p>登录账户</p>
                    <div class="lowin-group">
                        <label>身份</label>
                        <select name="role" class="lowin-input" id="roleSelect">
                            <option value="student">学生</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                    <div class="lowin-group">
                        <label>账号<a href="#" class="login-back-link">登录?</a></label>
                        <input type="text" id="sn" autocomplete="sn" name="username" class="lowin-input" placeholder="请输入账号"required>
                    </div>
                    <div class="lowin-group password-group">
                        <label>密码<a href="#" class="forgot-link"></a></label>
                        <input type="password" id="password" name="password" autocomplete="current-password" class="lowin-input" placeholder="请输入密码"required>
                    </div>
                    <div class="lowin-group">
                        <label>验证码</label>
                        <input type="text" name="captcha" id="captcha" autocomplete="off" class="lowin-input" placeholder="请输入验证码"required>
                        <img id="captchaImage" src="http://localhost:8080/student/captcha" alt="验证码" class="captcha-img" onclick="reloadCaptcha()" style="cursor: pointer;">
                    </div>
                    <button type="button" id="submitBtn" class="lowin-btn login-btn">
                        登录
                    </button>
                    <div class="text-foot">
                        没有帐户? <a href="#" class="register-link">注册</a>
                    </div>
                </form>
            </div>
        </div>

        <div class="lowin-box lowin-register" style="display: none;">
            <div class="lowin-box-inner">
                <form id="register-form">
                    <p>创建账户</p>
                    <div class="lowin-group">
                        <label>身份</label>
                        <input type="text" value="学生" class="lowin-input" readonly>
                        <input type="hidden" name="role" value="student">
                    </div>
                    <div class="lowin-group">
                        <label>姓名</label>
                        <input type="text" id="name" name="yourname" autocomplete="yourname" class="lowin-input" placeholder="请输入姓名" required>
                    </div>
                    <div class="lowin-group">
                        <label>性别</label>
                        <select name="yoursex" class="lowin-input" id="sex">
                            <option value="man">男</option>
                            <option value="woman">女</option>
                        </select>
                    </div>
                    <div class="lowin-group">
                        <label>qq</label>
                        <input type="text" id="qq" name="yourqq" autocomplete="qq" class="lowin-input" placeholder="请输入qq" required>
                    </div>
                    <div class="lowin-group">
                        <label>专业id</label>
                        <input type="text" id="clazz" name="classzzid" class="lowin-input" placeholder="请输入专业id" required>
                    </div>
                    <div class="lowin-group">
                        <label>账号</label>
                        <input type="text" id="sn1" name="name" autocomplete="name" class="lowin-input" placeholder="请输入账号" required>
                    </div>
                    <div class="lowin-group">
                        <label>密码</label>
                        <input type="password" id="new-password" autocomplete="new-password" name="new-password" class="lowin-input" placeholder="请输入密码" required>
                    </div>
                    <div class="lowin-group">
                        <label>确认密码</label>
                        <input type="password" id="confirm-password" name="password" autocomplete="current-password" class="lowin-input" placeholder="请确认密码" required>
                    </div>
                    <button type="button" id="registerBtn" class="lowin-btn">
                        注册
                    </button>
                    <div class="text-foot">
                        已有帐户? <a href="#" class="login-link">登录</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer class="lowin-footer">
        Design By <a href="https://www.cqu.edu.cn" target="_blank">重庆大学</a>
    </footer>
</div>

<script src="/js/auth.js"></script>
<script>
    Auth.init({
        login_url: '#login',
        forgot_url: '#forgot'
    });

    // 登录功能
    $(document).on('click', '#submitBtn', function() {
        var dataToSend = {
            role: $("#roleSelect").val(),
            sn: $("#sn").val(),
            password: $("#password").val(),
            captcha: $("#captcha").val()
        };
        if (dataToSend.sn == '' || dataToSend.password == ''||dataToSend.captcha=='') {
            alert('账号或密码不能为空，请重新输入');
            return;
        }
        $.ajax({
            type: "post",
            url: "http://localhost:8080/student/login", // 替换为你的登录地址
            data: dataToSend,
            dataType: "json",
            success: function(data){
                if(data.code == 200){
                    // 将user对象保存到localStorage
                    localStorage.setItem("'user", JSON.stringify(data.data));
                    localStorage.setItem("role",JSON.stringify(data.data.role));
                    window.location.href = "http://localhost:8080/index/index"; // 替换为需要跳转的页面
                } else {
                    alert("消息提醒: " + data.msg);
                    $("#captchaImage").click(); // 切换验证码
                    $("input[name='captcha']").val(""); // 清空验证码输入框
                }
            }
        });
    });

    // 注册功能
    $(document).on('click', '#registerBtn', function() {
        const registerForm = $('#register-form');
        const password = registerForm.find('input[name="new-password"]').val();
        const confirmPassword = $('#confirm-password').val();
        var dataToSend = {
            sn: $("#sn1").val(),
            password: $("#new-password").val(),
            sex: $("#sex").val(),
            qq: $("#qq").val(),
            clazz: $("#clazz").val(),
            role:"student",
            username: $("#name").val()
        };
        if (dataToSend.sn == '' || dataToSend.password == ''||dataToSend.username==''||dataToSend.sex==''||dataToSend.qq==''||dataToSend.clazz=='') {
            alert('必填项目不能为空，请重新输入');
            return;
        }
        if (password !== confirmPassword) {
            alert('密码和确认密码不一致，请重新输入。');
            return; // 结束注册
        }

        $.ajax({
            type: "post",
            url: "http://localhost:8080/student/register", // 替换为注册地址
            data: dataToSend,
            success: function(data) {
                if(data.code == 200) {
                    alert("注册成功，请登录！");
                } else {
                    alert("消息提醒： " + data.msg);
                }
            }
        });
    });

    // 切换到注册表单
    $(document).on('click', '.register-link', function() {
        $('.lowin-login').hide();
        $('.lowin-register').show();
    });

    // 切换到登录表单
    $(document).on('click', '.login-link', function() {
        $('.lowin-register').hide();
        $('.lowin-login').show();
    });
</script>
<script>
    // 重新加载验证码图片
    function reloadCaptcha() {
        var oldSrc = document.getElementById('captchaImage').src;
        var timestamp = new Date().getTime();
        var delimiter = oldSrc.indexOf('?') !== -1 ? '&' : '?';
        document.getElementById('captchaImage').src = oldSrc + delimiter + "t=" + timestamp;
    }
</script>
</body>
</html>